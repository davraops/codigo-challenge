name: App API Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  GO_VERSION: ${{ vars.GO_VERSION || '1.22' }}
  DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME || 'codigo-api' }}

jobs:
  release:
    name: Create Release
    runs-on: dedicated-runner
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            app/api
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: SCA Scan - Dependency vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'app/api'
          format: 'sarif'
          output: 'trivy-sca-results.sarif'
          severity: 'CRITICAL,HIGH'
          scanners: 'vulnerability'

      - name: Upload SCA results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-sca-results.sarif'

      - name: SAST Scan - Static code analysis
        uses: securego/gosec-action@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'
          working-directory: app/api

      - name: Upload SAST results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: app/api/gosec-results.sarif

      - name: Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ github.event.inputs.version }}-api" -m "Release ${{ github.event.inputs.version }} - API"
          git push origin "${{ github.event.inputs.version }}-api"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}-api
          name: Release ${{ github.event.inputs.version }} - API
          body: |
            ## Release ${{ github.event.inputs.version }} - API

            ### Security Scan Results
            - **SCA Scan**: Dependency vulnerability scan completed
            - **SAST Scan**: Static code analysis completed

            See GitHub Security tab for detailed results.

            ### Changes
            See commit history for changes in this release.

            **Commit**: `${{ github.sha }}`
            **Author**: ${{ github.actor }}
          draft: false
          prerelease: false

